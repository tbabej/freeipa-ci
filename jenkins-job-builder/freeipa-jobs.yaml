- defaults:
    name: global
    description: |
      This job is managed by jenkins-job-builder and will be overwritten.

      Do not edit this job through the web.
    project-type: freestyle
    concurrent: true
    disabled: false
    quiet-period: 5
    wrappers:
      - timeout:
          timeout: 30
          fail: true
      - timestamps
    logrotate:
        daysToKeep: 60
        numToKeep: 100

- publisher:
    name: mail-on-fail
    publishers:
        - email:
            recipients: pviktori@redhat.com

- publisher:
    name: nosetests-xunit
    publishers:
        - junit:
            results: nosetests.xml
            keep-long-stdio: false

- scm:
    name: freeipa-fedorahosted
    scm:
        - git:
            branches:
                - "{git-branch}"
            url: git://git.fedorahosted.org/git/freeipa.git
            shallow-clone: true
            use-author: true
            browser: gitweb
            browser-url: https://git.fedorahosted.org/cgit/freeipa.git/

- builder:
    name: install-builddeps
    builders:
        - shell: "sudo wget http://jdennis.fedorapeople.org/ipa-devel/ipa-devel-fedora.repo -O /etc/yum.repos.d/ipa-devel-fedora.repo"
        - shell: "sudo yum-config-manager --disable ipa-devel"
        - shell: |
            # FreeIPA requires:
            DEPS=$(grep "^BuildRequires" freeipa.spec.in | awk '{ print $2 }' | grep -v "^/")
            # Fedora min build env (https://fedoraproject.org/wiki/Packaging:Guidelines#Exceptions_2)
            DEPS="$DEPS bash bzip2 coreutils cpio diffutils fedora-release"
            DEPS="$DEPS findutils gawk gcc gcc-c++ grep gzip info make patch"
            DEPS="$DEPS redhat-rpm-config rpm-build sed shadow-utils tar unzip"
            DEPS="$DEPS util-linux which xz"
            # install all the RPMs
            sudo yum distro-sync -y --enablerepo updates-testing
            sudo yum install -y rpm-build $DEPS --enablerepo updates-testing
        - shell: "rpm -qa | sort"

- builder:
    name: install-built-rpms
    builders:
        - copyartifact:
            project: freeipa-build-{os}
            which-build: upstream-build
            fallback-to-last-successful: true
        - shell: "sudo yum remove -y 'freeipa-*' || :"
        - shell: "sudo wget http://jdennis.fedorapeople.org/ipa-devel/ipa-devel-fedora.repo -O /etc/yum.repos.d/ipa-devel-fedora.repo"
        - shell: "sudo yum-config-manager --disable ipa-devel"
        - shell: |
            sudo yum clean all
            sudo yum distro-sync -y --enablerepo updates-testing
            sudo yum install -y dist/rpms/freeipa-*.rpm bind-dyndb-ldap --enablerepo updates-testing
        - shell: "rpm -qa | sort"

- builder:
    name: build-rpms
    builders:
        - shell: |
            git clean -fxd
            echo 0.$(date -u +%Y%m%d%H%M%SZ)jenkins${BUILD_NUMBER}git$(git rev-parse --short HEAD) > RELEASE
            echo IPA_VERSION_IS_GIT_SNAPSHOT=no >> VERSION
            make rpms

- builder:
    name: uninstall
    builders:
        - shell: |
            sudo ipa-server-install --uninstall -U || :

- builder:
    name: clean-up-environment
    builders:
        - uninstall
        - shell: |
            sudo yum remove -y 'freeipa-*' || :
            sudo setenforce 1 || :
            sudo iptables -F || :
            sudo systemctl stop dirsrv.target || :
            sudo pkidestroy -s CA -i pki-tomcat || :
            sudo systemctl reset-failed pki-tomcatd@pki-tomcat.service || :

- builder:
    name: install
    builders:
        - shell: |
            # install
            sudo ipa-server-install \
                --setup-dns \
                    --forwarder=$FREEIPACI_DNS_FORWARDER \
                    --reverse-zone=$FREEIPACI_DNS_REVERSE_ZONE \
                -p $FREEIPACI_PASSWORD -a $FREEIPACI_PASSWORD \
                -r $FREEIPACI_REALM -n $FREEIPACI_DOMAIN \
                -U

            echo $FREEIPACI_PASSWORD | kinit admin

- builder:
    name: setup-default-conf
    builders:
        - shell: |
            mkdir -p ~/.ipa/
            echo """
            [global]
            basedn = $FREEIPACI_BASEDN
            realm = $FREEIPACI_REALM
            domain = $FREEIPACI_DOMAIN
            xmlrpc_uri = https://$(hostname)/ipa/xml
            enable_ra = True
            ra_plugin = dogtag
            in_tree=True
            wait_for_attr=True
            """ > ~/.ipa/default.conf

- builder:
    name: createrepo
    builders:
        - shell: "sudo yum install -y /usr/bin/createrepo"
        - shell: (cd dist/rpms; createrepo .)

- builder:
    name: create-ci-node-scripts
    builders:
      - shell: |
          cat > ~/ci_node_scripts.sh <<END
          ipaci-install-builddeps () {
          DEPS=$(grep "^BuildRequires" freeipa.spec.in | awk '{ print $2 }' | grep -v "^/")
          #
          # Default to stuff in Fedora
          sudo yum install -y rpm-build $DEPS --disablerepo updates-testing --skip-broken ||
          #
          # If there are problems, try updates-testing
          sudo yum install -y rpm-build $DEPS --enablerepo updates-testing --skip-broken ||
          #
          # If there are problems, also try ipa-devel
          sudo yum install -y rpm-build $DEPS --enablerepo updates-testing  --enablerepo ipa-devel --skip-broken
          }
          #
          #
          ipaci-install-rpms () {
          # Default to stuff in Fedora
          sudo yum install -y rpm-build "\$@" --disablerepo updates-testing --skip-broken ||
          #
          # If there are problems, try updates-testing
          sudo yum install -y rpm-build "\$@" --enablerepo updates-testing --skip-broken ||
          #
          # If there are problems, also try ipa-devel
          sudo yum install -y rpm-build "\$@" --enablerepo updates-testing  --enablerepo ipa-devel --skip-broken
          }
          #
          #
          ipaci-remove-rpms () {
          rm -rvf /root/ipatests
          mkdir -p /root/ipatests/rpms
          }
          END

- builder:
    name: setup-host
    builders:
      - shell: |
          source ~/env.sh
          # Set SSH options
          export SSH_OPTS="-i $IPA_ROOT_SSH_KEY -o StrictHostKeyChecking=no"
          # Copy ci-node-scripts over
          scp $SSH_OPTS ~/ci_node_scripts.sh root@{host}:/root/ci_node_scripts.sh
          # Remove rpms directory on the host
          ssh $SSH_OPTS root@{host} <<END
          PS4="+$(hostname)+"; set -ex
          source /root/ci_node_scripts.sh
          ipaci-remove-rpms
          yum update -y
          END
          # Copy new rpms over
          scp $SSH_OPTS dist/rpms/freeipa-*.rpm root@{host}:/root/ipatests/rpms
          # Remove the old packages and install new
          ssh $SSH_OPTS root@{host} <<END
          PS4="+$(hostname)+"; set -ex
          source /root/ci_node_scripts.sh
          sudo yum remove -y 'freeipa-*' || :
          ipaci-install-rpms /root/ipatests/rpms/freeipa-*.rpm bind-dyndb-ldap ntpdate
          yum localinstall -y /root/slapi-nis-0.52-1.fc20.x86_64.rpm
          rpm -qa | sort
          END

- builder:
    name: cleanup-host
    builders:
      - shell: |
          source ~/env.sh
          # Set SSH options
          export SSH_OPTS="-i $IPA_ROOT_SSH_KEY -o StrictHostKeyChecking=no"
          # Copy ci-node-scripts over
          scp $SSH_OPTS ~/ci_node_scripts.sh root@{host}:/root/ci_node_scripts.sh
          # Uninstall IPA
          ssh $SSH_OPTS root@{host} <<END
          PS4="+$(hostname)+"; set -ex
          source /root/ci_node_scripts.sh
          ipa-server-install --uninstall -U
          ipaci-remove-rpms
          END

- job-template:
    name: freeipa-build-{os}
    node: freeipa-builder-{os}
    defaults: global
    description: |
        Build and archive FreeIPA RPMs.
    scm:
        - freeipa-fedorahosted:
            git-branch: "{git-branch}"
    wrappers:
        - workspace-cleanup
    builders:
        - install-builddeps
        - build-rpms
        - createrepo
    publishers:
        - mail-on-fail
        - warnings:
            console-log-parsers:
                - GNU Compiler 4 (gcc)
            only-use-stable-builds-as-reference: true
            total-thresholds:
                unstable:
                    total-all: 1
        - archive:
            artifacts: 'dist/rpms/**'
        - fingerprint:
            record-artifacts: true
        - trigger:
            project: freeipa-check-deps-{os}
            threshold: UNSTABLE

- job-template:
    name: freeipa-check-deps-{os}
    node: freeipa-builder-{os}
    defaults: global
    description: |
        Check that the built RPMs are actually installable.

        (Managed by jenkins-job-builder. Do not edit this job directly.)
    wrappers:
        - workspace-cleanup
    builders:
        - install-built-rpms:
            os: "{os}"
        - shell: "sudo yum check-update"
        - shell: "rpm -qa | sort"
    publishers:
        - mail-on-fail
    publishers:
        - trigger:
            project: freeipa-intree-tests-{os}
        - trigger:
            project: freeipa-outoftree-tests-{os}

- job-template:
    name: freeipa-intree-tests-{os}
    node: freeipa-runner-{os}
    defaults: global
    description: |
        Run the FreeIPA test suite (sans WebUI & Integration), in-tree.
    scm:
        - freeipa-fedorahosted:
            git-branch: "{git-branch}"
    wrappers:
        - workspace-cleanup
    builders:
        - clean-up-environment
        - install-built-rpms:
            os: "{os}"
        - shell: |
            # We're running in-tree tests, but we get compiled files from RPMs
            cp /usr/lib/python2.7/site-packages/ipapython/version.py ipapython/version.py
            cp /usr/lib/python2.7/site-packages/ipapython/services.py ipapython/services.py
            cp /usr/sbin/ipa-getkeytab ipa-client/ipa-getkeytab
        - install
        - setup-default-conf
        - shell: |
            # set up cert
            rm -rvf ~/.ipa/alias
            sudo cp -R /etc/httpd/alias ~/.ipa/alias
            sudo cp  /etc/httpd/alias/pwdfile.txt ~/.ipa/alias/.pwd
            sudo chown -R jenkins:jenkins ~/.ipa/alias/
            rm tests/test_xmlrpc/service.crt || :
        - shell: |
            ./make-testcert
            ./make-test --with-xunit || :
        - uninstall
    publishers:
        - nosetests-xunit
        - mail-on-fail
    triggers:
        - timed:
            # Do the check nightly
            "H H(0-5) * * *"

- job-template:
    name: freeipa-outoftree-tests-{os}
    node: freeipa-runner-{os}
    defaults: global
    description: |
        Run the FreeIPA test suite (sans WebUI & Integration), out-of-tree.
    wrappers:
        - workspace-cleanup
    builders:
        - clean-up-environment
        - install-built-rpms:
            os: "{os}"
        - install
        - setup-default-conf
        - shell: |
            ipa-run-tests --with-xunit || :
        - uninstall
    publishers:
        - nosetests-xunit
        - mail-on-fail

- job-template:
    name: freeipa-adintegration-tests-{os}
    node: freeipa-runner-{os}
    defaults: global
    description: |
        Run all the AD integration related tests, out of tree.
    wrappers:
        - workspace-cleanup
    builders:
        - clean-up-environment
        - install-built-rpms:
            os: "{os}"
        - setup-default-conf
        - create-ci-node-scripts
        - setup-host:
            host: "$MASTER_env1"
        - shell: |
            source ~/env.sh
            ipa-run-tests test_integration/test_trust.py --no-skip --with-xunit || :
            ipa-test-config --global
        - cleanup-host:
            host: "$MASTER_env1"
    publishers:
        - nosetests-xunit
        - mail-on-fail

- job-group:
    name: build-and-check
    jobs:
        - freeipa-stats-{os}
        - freeipa-build-{os}
        - freeipa-check-deps-{os}
        - freeipa-intree-tests-{os}
        - freeipa-adintegration-tests-{os}
        - freeipa-outoftree-tests-{os}
        - freeipa-webui-{browser}-{os}-{prettyname}:
            prettyname: with-dns-with-ca
            noca: False
            nodns: False
            browser: firefox
        - freeipa-webui-{browser}-{os}-{prettyname}:
            prettyname: no-dns-no-ca
            noca: True
            nodns: True
            browser: firefox
            options-dns-setup: ""
            options-ca-setup: >
                --http_pkcs12 star-cert.p12 \
                --dirsrv_pkcs12 star-cert.p12 \
                --http_pin $FREEIPACI_STAR_CERT_PIN --dirsrv_pin $FREEIPACI_STAR_CERT_PIN \
                --root-ca-file star-cert-ca.crt
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: caless
            suite: test_integration/test_caless.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: master
                      - name: replica.ipa.test
                        role: replica
                      - name: client.ipa.test
                        role: client
                    name: ipa.test
                    type: IPA
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: simple_replication
            suite: test_integration/test_simple_replication.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: master
                      - name: replica.ipa.test
                        role: replica
                    name: ipa.test
                    type: IPA
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: external_ca
            suite: test_integration/test_external_ca.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: master
                    name: ipa.test
                    type: IPA
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: forced_client_reenrollment
            suite: test_integration/test_forced_client_reenrollment.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: master
                      - name: replica.ipa.test
                        role: replica
                      - name: client.ipa.test
                        role: client
                    name: ipa.test
                    type: IPA
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: kerberos_flags
            suite: test_integration/test_kerberos_flags.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: master
                      - name: client.ipa.test
                        role: client
                    name: ipa.test
                    type: IPA
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: basic_trust
            suite: test_integration/test_trust.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: trust_master
                    name: ipa.test
                    type: TRUST_IPA
                  - hosts:
                      - name: ad
                        role: ad
                    name: ad.test
                    type: AD
        - freeipa-integration-{os}-{pretty_name}:
            pretty_name: legacy_clients
            suite: test_integration/test_legacy_clients.py
            config_template: |
                domains:
                  - hosts:
                      - name: master.ipa.test
                        role: trust_master
                      - name: legacy_client_sssd_redhat.ipa.test
                        role: legacy_client_sssd_redhat
                      - name: legacy_client_nss_ldap_redhat.ipa.test
                        role: legacy_client_nss_ldap_redhat
                      - name: legacy_client_nss_pam_ldapd_redhat.ipa.test
                        role: legacy_client_nss_pam_ldapd_redhat
                    name: ipa.test
                    type: TRUST_IPA
                  - hosts:
                      - name: ad.ad.test
                        role: ad
                      - name: child.child.ad.test
                        role: ad_subdomain
                    name: ad.test
                    type: AD
- job-template:
    name: freeipa-stats-{os}
    node: freeipa-builder-{os}
    defaults: global
    description: |
        Collect some stats on the FreeIPA code
    scm:
        - freeipa-fedorahosted:
            git-branch: "{git-branch}"
    triggers:
        - pollscm: "H/15 * * * *"
    builders:
        - shell: |
            sudo yum install -y python-pip sloccount
            pip install --user flake8
        - shell: |
            git clean -ffxd
            echo -n 'YVALUE=' > pep8.properties

            ~/.local/bin/flake8 --version
            ~/.local/bin/flake8 . --statistics --count 2>> pep8.properties || :
        - shell: |
            /usr/bin/sloccount --duplicates --wide --details . > sloccount.sc
    publishers:
        - trigger:
            project: freeipa-build-{os}
        - mail-on-fail
        - plot:
          - title: PEP8+pyflakes problems
            yaxis: problems
            group: stats
            style: line
            series:
              - file: pep8.properties
                label: MyLabel
                format: properties
        - sloccount:
            report-files: sloccount.sc
            charset: UTF-8

- project:
    name: f20
    os: f20
    git-branch: master
    jobs:
        - build-and-check

######### Meta-tests; use these for experimenting

- job-template:
    name: test1
    node: master
    builders:
        shell: "echo 1"

- job-template:
    name: test2
    node: master
    builders:
        shell: "echo 1"

- project:
    name: test
    jobs:
        - test1
        - test2
